#!/bin/bash
USAGE="ABVC delta output_prefix"
if [ -z "$1" ]
  then
    echo "ERROR in ABVC: No delta file given"
    echo "Usage:"
    echo $USAGE
    exit
fi
if [ -z "$2" ]
  then
    echo "ERROR in ABVC: No output prefix given"
    echo "Usage:"
    echo $USAGE
    exit
fi

# Author: Maria Nattestad
# Email: mnattest@cshl.edu

DELTA=${1?"$USAGE"}
OUTPUT_PREFIX=${2?"$USAGE"}

>&2 echo Input delta file: $DELTA
>&2 echo Output prefix: $OUTPUT_PREFIX

MINIMUM_SIZE=50
UNIQUE_LENGTH=10000

>&2 echo "1. Filter delta file"
delta-filter -l $UNIQUE_LENGTH $DELTA > $OUTPUT_PREFIX.l$UNIQUE_LENGTH.delta

if grep -q ">" $OUTPUT_PREFIX.l$UNIQUE_LENGTH.delta; 
then 
    echo "DELTAFILTER,DONE" >> $OUTPUT_PREFIX.progress.log
    ./bin/ABVC_uniq_len_filter.py --delta $OUTPUT_PREFIX.l$UNIQUE_LENGTH.delta --unique-length $UNIQUE_LENGTH --out $OUTPUT_PREFIX.ABVC_uniq_len_filtered.delta
    if grep -q ">" $OUTPUT_PREFIX.ABVC_uniq_len_filtered.delta; 
    then 
        echo "UNIQFILTER,DONE" >> $OUTPUT_PREFIX.progress.log
        >&2 echo "2. Finding variants between alignments"
        ./bin/ABVC_between_alignments.pl  $OUTPUT_PREFIX.ABVC_uniq_len_filtered.delta $MINIMUM_SIZE all-chromosomes exclude-longrange bed > $OUTPUT_PREFIX.ABVC_variants_between_alignments.bed

        if grep -q "between_alignments" $OUTPUT_PREFIX.ABVC_variants_between_alignments.bed; 
        then 
            echo "BETWEEN,DONE" >> $OUTPUT_PREFIX.progress.log
            >&2 echo "3. Finding variants within alignments"
            ./bin/ABVC_within_alignment.py --delta $OUTPUT_PREFIX.ABVC_uniq_len_filtered.delta --min $MINIMUM_SIZE > $OUTPUT_PREFIX.ABVC_variants_within_alignments.bed

            if grep -q "within_alignment" $OUTPUT_PREFIX.ABVC_variants_within_alignments.bed; 
            then 
                echo "WITHIN,DONE" >> $OUTPUT_PREFIX.progress.log
                >&2 echo "4. Combine variants between and within alignments"
                cat $OUTPUT_PREFIX.ABVC_variants_within_alignments.bed $OUTPUT_PREFIX.ABVC_variants_between_alignments.bed > $OUTPUT_PREFIX.ABVC_structural_variants.bed

                if grep -q "ABVC" $OUTPUT_PREFIX.ABVC_structural_variants.bed; 
                then 
                    echo "COMBINE,DONE" >> $OUTPUT_PREFIX.progress.log
                    ./bin/ABVC_summary.py -i $OUTPUT_PREFIX.ABVC_structural_variants.bed > $OUTPUT_PREFIX.ABVC_structural_variants.summary

                    if grep -q "Total" $OUTPUT_PREFIX.ABVC_structural_variants.summary; 
                    then 
                        echo "SUMMARY,DONE" >> $OUTPUT_PREFIX.progress.log
                    else
                        echo "SUMMARY,FAIL,step4: ABVC_summary.py failed" >> $OUTPUT_PREFIX.progress.log
                    fi
                else
                    echo "COMBINE,FAIL,step4: cat failed" >> $OUTPUT_PREFIX.progress.log
                fi
            else
                echo "WITHIN,FAIL,step3: ABVC_within_alignment.py failed: Possible problem before this step or with Python on server" >> $OUTPUT_PREFIX.progress.log
            fi
        else
            echo "BETWEEN,FAIL,step2: ABVC_between_alignments.pl failed: Possible problem with Perl or show-coords on server." >> $OUTPUT_PREFIX.progress.log
        fi
    else
        echo "UNIQFILTER,FAIL,step1: ABVC_uniq_len_filter.py failed: Possible problem with Python or Python packages on server." >> $OUTPUT_PREFIX.progress.log
    fi
else
    echo "DELTAFILTER,FAIL,step1: delta-filter failed: Not a real delta file." >> $OUTPUT_PREFIX.progress.log
fi







